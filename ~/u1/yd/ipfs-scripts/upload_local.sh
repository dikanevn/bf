#!/bin/bash

# Скрипт для загрузки файлов в IPFS с использованием только локального шлюза
# Это позволяет обойти проблемы с VPN

# Проверка наличия аргумента с путем к файлу
if [ -z "$1" ]; then
    echo "Ошибка: Не указан путь к файлу для загрузки"
    echo "Использование: $0 <путь_к_файлу>"
    exit 1
fi

# Проверка существования файла
if [ ! -f "$1" ]; then
    echo "Ошибка: Файл '$1' не существует"
    exit 1
fi

# Установка пути к IPFS
export IPFS_PATH=/home/dikanevn/u1/yd/.ipfs

# Загрузка файла в IPFS с использованием CIDv1
echo "Загрузка файла в IPFS..."
CID=$(ipfs add --cid-version=1 --hash=sha2-256 -q "$1")

if [ $? -ne 0 ]; then
    echo "Ошибка при загрузке файла в IPFS"
    exit 1
fi

echo "Файл успешно загружен в IPFS!"
echo "CID: $CID"
echo "Локальный доступ: http://localhost:8080/ipfs/$CID"
echo "IPFS URI: ipfs://$CID"

# Закрепление файла в IPFS
echo "Закрепление файла в IPFS..."
ipfs pin add "$CID" > /dev/null

# Проверка доступности файла через локальный шлюз
echo "Проверка доступности файла через локальный шлюз..."
if curl -s -f -m 5 http://localhost:8080/ipfs/$CID > /dev/null
then
    echo "Файл доступен через локальный шлюз"
else
    echo "Предупреждение: Файл недоступен через локальный шлюз. Возможно, IPFS демон не запущен."
    echo "Запустите IPFS демон командой: ipfs daemon"
fi

echo ""
echo "ВАЖНО: При использовании VPN, доступ к файлу может быть ограничен через публичные шлюзы."
echo "Используйте локальный шлюз для доступа к файлам: http://localhost:8080/ipfs/$CID" 